# Техническое задание: TaskMate Server (Backend API)

**Версия документа:** 1.3
**Дата создания:** До начала разработки
**Дата актуализации:** 28.01.2026
**Проект:** TaskMate — система управления задачами для автосалонов

---

## 1. Общее описание проекта

### 1.1 Назначение системы

TaskMate — корпоративная система управления задачами, разработанная специально для автосалонов. Система обеспечивает:

- Централизованное управление задачами сотрудников
- Контроль выполнения работ с подтверждением (фото/видео доказательства)
- Учёт рабочих смен персонала
- Автоматическую генерацию повторяющихся задач
- Многоуровневую систему ролей и полномочий
- Поддержку нескольких автосалонов (мультитенантность)

### 1.2 Целевая аудитория

- **Владельцы сети автосалонов** — полный контроль над всеми салонами
- **Менеджеры салонов** — управление задачами и сотрудниками в рамках своего салона
- **Наблюдатели** — просмотр информации без права редактирования
- **Сотрудники** — получение и выполнение задач

### 1.3 Технологический стек

- **Фреймворк:** Laravel 12
- **Язык:** PHP 8.4
- **База данных:** PostgreSQL (только PostgreSQL, не MySQL)
- **Кэш/Очереди:** Valkey (Redis-совместимый)
- **Аутентификация:** Laravel Sanctum (Bearer tokens)
- **Хранение файлов:** Локальное приватное хранилище

---

## 2. Функциональные требования

### 2.1 Модуль аутентификации и авторизации

#### 2.1.1 Аутентификация

| Требование | Описание |
|------------|----------|
| AUTH-001 | Вход по логину и паролю |
| AUTH-002 | Генерация Bearer token при успешном входе |
| AUTH-003 | Выход из системы (инвалидация токена) |
| AUTH-004 | Получение информации о текущем пользователе |
| AUTH-005 | Защита от брутфорса: блокировка после N неудачных попыток |
| AUTH-006 | Отслеживание неудачных попыток входа (failed_login_attempts, locked_until) |

#### 2.1.2 Роли пользователей

| Роль | Уровень доступа | Описание |
|------|-----------------|----------|
| owner | 4 (высший) | Полный доступ ко всем салонам, настройкам, аудиту |
| manager | 3 | Управление задачами, верификация, настройки своего салона |
| observer | 2 | Только просмотр информации |
| employee | 1 | Просмотр назначенных задач, выполнение, загрузка доказательств |

#### 2.1.3 Матрица прав доступа

| Операция | Owner | Manager | Observer | Employee |
|----------|-------|---------|----------|----------|
| Создание пользователей | ✓ | ✓* | ✗ | ✗ |
| Создание задач | ✓ | ✓* | ✗ | ✗ |
| Редактирование задач | ✓ | ✓* | ✗ | ✗ |
| Удаление задач | ✓ | ✓* | ✗ | ✗ |
| Просмотр всех задач | ✓ | ✓* | ✓ | ✗ |
| Просмотр своих задач | ✓ | ✓ | ✓ | ✓ |
| Выполнение задач | ✓ | ✓ | ✗ | ✓ |
| Загрузка доказательств | ✓ | ✓ | ✗ | ✓ |
| Верификация доказательств | ✓ | ✓* | ✗ | ✗ |
| Управление генераторами задач | ✓ | ✓* | ✗ | ✗ |
| Управление настройками (глобальные/shift-config) | ✓ | ✗ | ✗ | ✗ |
| Управление настройками (notification/archive/task-config) | ✓ | ✓* | ✗ | ✗ |
| Просмотр аудит-логов (полный список) | ✓ | ✗ | ✗ | ✗ |
| Просмотр аудит-логов (история записи) | ✓ | ✓* | ✗ | ✗ |
| Управление календарём | ✓ | ✓* | ✗ | ✗ |

*только для своего салона

---

### 2.2 Модуль управления пользователями

#### 2.2.1 Сущность User

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| id | bigint | auto | Первичный ключ |
| login | string(255) | обязательно | Уникальный логин |
| full_name | string(255) | обязательно | ФИО сотрудника |
| phone | string(20) | опционально | Телефон |
| role | enum | обязательно | Роль: owner, manager, observer, employee |
| dealership_id | bigint | опционально | Основной салон |
| password | string | обязательно | Хэш пароля |
| failed_login_attempts | int | default 0 | Счётчик неудачных входов |
| locked_until | datetime | nullable | Время разблокировки |
| last_failed_login_at | datetime | nullable | Время последней неудачной попытки входа |
| deleted_at | datetime | nullable | Мягкое удаление |

#### 2.2.2 Требования

| ID | Описание |
|----|----------|
| USER-001 | CRUD операции для пользователей |
| USER-002 | Мягкое удаление (SoftDeletes) |
| USER-003 | Привязка к нескольким салонам (many-to-many через dealership_user) |
| USER-004 | Проверка онлайн-статуса пользователя |

---

### 2.3 Модуль автосалонов (AutoDealership)

#### 2.3.1 Сущность AutoDealership

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| id | bigint | auto | Первичный ключ |
| name | string(255) | обязательно | Название салона |
| address | string(500) | опционально | Адрес |
| phone | string(20) | опционально | Телефон |
| timezone | string(50) | опционально | Часовой пояс (например, Europe/Moscow) |
| description | text | опционально | Описание |
| is_active | boolean | default true | Активность салона |

#### 2.3.2 Требования

| ID | Описание |
|----|----------|
| DEAL-001 | CRUD операции для автосалонов |
| DEAL-002 | Каждый салон изолирован (мультитенантность) |

---

### 2.4 Модуль задач (Tasks)

#### 2.4.1 Сущность Task

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| id | bigint | auto | Первичный ключ |
| generator_id | bigint | nullable | Ссылка на генератор (если создана автоматически) |
| title | string(255) | обязательно | Заголовок задачи |
| description | text | опционально | Подробное описание |
| comment | text | опционально | Комментарий |
| creator_id | bigint | обязательно | Создатель задачи |
| dealership_id | bigint | обязательно | Салон |
| appear_date | datetime | обязательно | Дата появления задачи |
| deadline | datetime | обязательно | Дедлайн выполнения |
| scheduled_date | date | опционально | Запланированная дата |
| task_type | enum | обязательно | Тип: individual, group |
| target_shift_type | string | опционально | Целевой тип смены |
| response_type | enum | обязательно | Тип ответа: notification, completion, completion_with_proof |
| tags | json | nullable | Теги задачи |
| priority | enum | default medium | Приоритет: low, medium, high |
| is_active | boolean | default true | Активность |
| postpone_count | int | default 0 | Счётчик откладываний |
| archived_at | datetime | nullable | Дата архивации |
| archive_reason | string | nullable | Причина архивации |
| notification_settings | json | nullable | Настройки уведомлений |
| deleted_at | datetime | nullable | Мягкое удаление |

#### 2.4.2 Типы задач (task_type)

| Тип | Описание |
|-----|----------|
| individual | Индивидуальная задача для одного исполнителя |
| group | Групповая задача для нескольких исполнителей |

#### 2.4.3 Типы ответа (response_type)

| Тип | Описание | Действия пользователя |
|-----|----------|----------------------|
| notification | Уведомление | Подтвердить получение (OK) |
| completion | Задача на выполнение | Отметить выполненной / Отложить |
| completion_with_proof | Задача с доказательством | Загрузить файлы + Отправить на проверку |

#### 2.4.4 Статусы задач (вычисляемые)

| Статус | Приоритет | Описание |
|--------|-----------|----------|
| pending | 1 | Нет ответов |
| acknowledged | 2 | Подтверждено получение (для notification) |
| pending_review | 3 | Ожидает проверки менеджером |
| overdue | 4 | Просрочена |
| completed | 5 | Выполнена вовремя |
| completed_late | 6 | Выполнена с опозданием |

**Важно:** Статус задачи НЕ хранится в базе, а вычисляется на основе ответов исполнителей.

#### 2.4.5 Требования к задачам

| ID | Описание |
|----|----------|
| TASK-001 | CRUD операции для задач |
| TASK-002 | Назначение задач пользователям или ролям |
| TASK-003 | Мягкое удаление задач |
| TASK-004 | Вычисление статуса на основе ответов |
| TASK-005 | Проверка дубликатов (title + task_type + dealership + deadline) |
| TASK-006 | Фильтрация по: статусу, салону, типу, приоритету, датам |
| TASK-007 | Для групповых задач: статус "выполнено" только когда ВСЕ ответили |
| TASK-008 | Архивация: вручную и автоматически |
| TASK-009 | История ответов пользователя (my-history) |

---

### 2.5 Модуль назначений (TaskAssignment)

#### 2.5.1 Сущность TaskAssignment

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_id | bigint | Ссылка на задачу |
| user_id | bigint | Назначенный пользователь |
| role | string | Роль (для назначения по ролям) |
| assigned_at | datetime | Дата назначения |
| deleted_at | datetime | Мягкое удаление |

#### 2.5.2 Требования

| ID | Описание |
|----|----------|
| ASGN-001 | Индивидуальная задача: максимум 1 назначение |
| ASGN-002 | Групповая задача: минимум 1 назначение |
| ASGN-003 | Мягкое удаление для сохранения истории |

---

### 2.6 Модуль ответов на задачи (TaskResponse)

#### 2.6.1 Сущность TaskResponse

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_id | bigint | Ссылка на задачу |
| user_id | bigint | Отвечающий пользователь |
| shift_id | bigint | Смена, в которую дан ответ |
| status | enum | acknowledged, completed, pending_review, rejected |
| comment | text | Комментарий пользователя |
| responded_at | datetime | Время ответа |
| completed_during_shift | boolean | Выполнено во время смены |
| verified_at | datetime | Время верификации |
| verified_by | bigint | Кто верифицировал |
| rejection_reason | text | Причина отклонения |
| rejection_count | int | Счётчик отклонений |
| submission_source | enum | individual, shared |
| uses_shared_proofs | boolean | Использует общие доказательства группы |

#### 2.6.2 Требования

| ID | Описание |
|----|----------|
| RESP-001 | Создание ответа на задачу |
| RESP-002 | Обновление статуса ответа |
| RESP-003 | Цикл верификации: подтверждение / отклонение |
| RESP-004 | Повторная отправка после отклонения |
| RESP-005 | Отслеживание количества отклонений |

---

### 2.7 Модуль доказательств (TaskProof)

#### 2.7.1 Сущность TaskProof (индивидуальные)

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_response_id | bigint | Ссылка на ответ |
| file_path | string | Путь к файлу |
| original_filename | string | Оригинальное имя файла |
| mime_type | string | MIME-тип |
| file_size | bigint | Размер в байтах |

#### 2.7.2 Сущность TaskSharedProof (общие для группы)

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_id | bigint | Ссылка на задачу |
| file_path | string | Путь к файлу |
| original_filename | string | Оригинальное имя файла |
| mime_type | string | MIME-тип |
| file_size | bigint | Размер в байтах |

#### 2.7.3 Требования к файлам

| ID | Описание |
|----|----------|
| PROOF-001 | Максимум 5 файлов на один ответ |
| PROOF-002 | Максимальный размер файла по категориям: изображения — 5 МБ, документы — 50 МБ, видео — 100 МБ |
| PROOF-002a | Максимальный общий размер всех файлов ответа: 200 МБ |
| PROOF-003 | Разрешённые форматы изображений: JPG, JPEG, PNG, GIF, WebP |
| PROOF-003a | Разрешённые форматы документов: PDF, DOC, DOCX, XLS, XLSX, CSV, ODT, TXT, JSON |
| PROOF-003b | Разрешённые форматы архивов: ZIP, TAR, 7Z |
| PROOF-003c | Разрешённые форматы видео: MP4, WebM, MOV, AVI |
| PROOF-004 | Валидация содержимого по magic bytes (не только по расширению) |
| PROOF-005 | Приватное хранилище: диск `task_proofs` |
| PROOF-006 | Доступ через подписанные URL (срок действия: 60 минут) |
| PROOF-007 | Удаление файлов при удалении ответа (асинхронно через Job) |

---

### 2.8 Модуль верификации (TaskVerification)

#### 2.8.1 Сущность TaskVerificationHistory

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_response_id | bigint | Ссылка на ответ |
| action | enum | submitted, approved, rejected, resubmitted |
| performed_by | bigint | Кто выполнил действие |
| reason | text | Причина (для отклонения) |
| previous_status | string | Предыдущий статус |
| new_status | string | Новый статус |
| proof_count | int | Количество доказательств |
| created_at | datetime | Время действия |

#### 2.8.2 Workflow верификации

```
Сотрудник загружает доказательства
          ↓
    status = pending_review
          ↓
    Менеджер проверяет
          ↓
   ┌──────┴──────┐
   ↓             ↓
APPROVED      REJECTED
   ↓             ↓
completed    rejected
             (можно
             повторить)
```

#### 2.8.3 Требования

| ID | Описание |
|----|----------|
| VERIF-001 | Подтверждение доказательств (approve) |
| VERIF-002 | Отклонение с указанием причины (reject) |
| VERIF-003 | Массовое отклонение всех ответов задачи |
| VERIF-004 | Полная история всех действий верификации |
| VERIF-005 | Только manager и owner могут верифицировать |

---

### 2.9 Модуль смен (Shift)

#### 2.9.1 Сущность Shift

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| user_id | bigint | Сотрудник |
| dealership_id | bigint | Салон |
| shift_start | datetime | Фактическое начало |
| shift_end | datetime | Фактическое окончание |
| opening_photo_path | string | Фото открытия |
| closing_photo_path | string | Фото закрытия |
| status | enum | open, late, closed, replaced |
| shift_type | string | Тип смены |
| late_minutes | int | Минуты опоздания |
| scheduled_start | datetime | Плановое начало |
| scheduled_end | datetime | Плановое окончание |
| archived_tasks_processed | boolean | Задачи обработаны при архивации |

#### 2.9.2 Статусы смен

| Статус | Описание |
|--------|----------|
| open | Смена активна |
| late | Смена активна, начата с опозданием |
| closed | Смена закрыта нормально |
| replaced | Сотрудник был заменён |

#### 2.9.3 Требования

| ID | Описание |
|----|----------|
| SHIFT-001 | Открытие смены с фото |
| SHIFT-002 | Закрытие смены с фото |
| SHIFT-003 | Расчёт опоздания (late_minutes) |
| SHIFT-004 | Получение текущей активной смены |
| SHIFT-005 | История смен пользователя |
| SHIFT-006 | Статистика по сменам |

---

### 2.10 Модуль замены смен (ShiftReplacement)

#### 2.10.1 Сущность ShiftReplacement

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| shift_id | bigint | Ссылка на смену |
| replacing_user_id | bigint | Заменяющий сотрудник |
| replaced_user_id | bigint | Заменяемый сотрудник |
| reason | text | Причина замены |

#### 2.10.2 Требования

| ID | Описание |
|----|----------|
| REPL-001 | Регистрация замены сотрудника |
| REPL-002 | Переназначение задач на заменяющего |
| REPL-003 | Статус смены → replaced |

---

### 2.11 Модуль генераторов задач (TaskGenerator)

#### 2.11.1 Сущность TaskGenerator

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| title | string(255) | Шаблон заголовка |
| description | text | Шаблон описания |
| comment | text | Комментарий |
| creator_id | bigint | Создатель |
| dealership_id | bigint | Салон |
| recurrence | enum | none, daily, weekly, monthly |
| recurrence_time | time | Время генерации (HH:mm:ss) |
| deadline_time | time | Время дедлайна (HH:mm:ss) |
| recurrence_days_of_week | json | Дни недели [1-7] (для weekly) |
| recurrence_days_of_month | json | Дни месяца [1-31 или -1,-2] (для monthly) |
| start_date | date | Дата начала генерации |
| end_date | date | Дата окончания генерации |
| last_generated_at | datetime | Последняя генерация |
| task_type | enum | individual, group |
| response_type | enum | notification, completion, completion_with_proof |
| priority | enum | low, medium, high |
| tags | json | Теги |
| notification_settings | json | Настройки уведомлений |
| is_active | boolean | Активность генератора |

#### 2.11.2 Типы повторения

| Тип | Описание | Параметры |
|-----|----------|-----------|
| none | Одноразовая генерация | — |
| daily | Ежедневно | — |
| weekly | Еженедельно | recurrence_days_of_week: [1,2,3,4,5] |
| monthly | Ежемесячно | recurrence_days_of_month: [1,15,-1] |

#### 2.11.3 Требования

| ID | Описание |
|----|----------|
| GEN-001 | CRUD операции для генераторов |
| GEN-002 | Автоматическая генерация задач (каждые 5 минут) |
| GEN-003 | Проверка: активен, в диапазоне дат, не праздник |
| GEN-004 | Проверка соответствия паттерну (daily/weekly/monthly) |
| GEN-005 | Предотвращение дублирования (last_generated_at) |
| GEN-006 | Пауза/возобновление генератора |
| GEN-007 | Массовая пауза/возобновление всех генераторов |
| GEN-008 | Статистика генератора (сколько задач создано) |
| GEN-009 | Список задач, созданных генератором |

#### 2.11.4 Сущность TaskGeneratorAssignment

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| generator_id | bigint | Ссылка на генератор |
| user_id | bigint | Назначенный пользователь |
| created_at | datetime | Дата создания |
| updated_at | datetime | Дата обновления |

Назначения генератора определяют, каким пользователям будут назначены автоматически сгенерированные задачи.

---

### 2.12 Модуль календаря (CalendarDay)

#### 2.12.1 Сущность CalendarDay

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| dealership_id | bigint | Салон (null = глобально) |
| date | date | Дата |
| type | enum | holiday, workday |
| description | string | Описание |

#### 2.12.2 Логика раздельного хранения

Система использует подход **«всё или ничего»** для календаря автосалона:

| Состояние | Поведение |
|-----------|-----------|
| Нет собственного календаря | Используется глобальный календарь полностью |
| Есть собственный календарь | Используется ТОЛЬКО собственный (без fallback на глобальный) |

**Автоматическое копирование при первом изменении:**

При первом изменении календаря автосалона (через `update` или `bulkUpdate`) система автоматически копирует все глобальные записи за год в календарь автосалона, затем применяет изменение. Это обеспечивает предсказуемое поведение: после первого изменения автосалон полностью независим от глобального календаря.

**Флаг `uses_global`:**

API возвращает флаг `uses_global` в ответах, указывающий использует ли автосалон глобальный календарь (`true`) или имеет собственный (`false`).

#### 2.12.3 Требования

| ID | Описание |
|----|----------|
| CAL-001 | Получение календаря на год с флагом `uses_global` |
| CAL-002 | Получение праздников на год с флагом `uses_global` |
| CAL-003 | Проверка, является ли дата праздником |
| CAL-004 | Установка дня как праздник/рабочий |
| CAL-005 | Удаление переопределения дня |
| CAL-006 | Массовые операции с календарём |
| CAL-007 | Раздельное хранение: глобальный ИЛИ собственный (без смешивания) |
| CAL-008 | Автокопирование глобальных записей при первом изменении автосалона |
| CAL-009 | Сброс календаря автосалона к глобальному (удаление всех записей автосалона) |
| CAL-010 | Флаг `copied_from_global` в meta ответа при автокопировании |

---

### 2.13 Модуль уведомлений (NotificationSettings)

#### 2.13.1 Каналы уведомлений

| Канал | Описание |
|-------|----------|
| task_assigned | Назначение новой задачи |
| task_deadline_30min | 30 минут до дедлайна |
| task_overdue | Задача просрочена |
| task_hour_late | Задача просрочена на час |
| shift_late | Опоздание на смену |
| task_postponed | Задача отложена |
| shift_replacement | Замена на смене |
| daily_summary | Ежедневная сводка |
| weekly_report | Еженедельный отчёт |

#### 2.13.2 Сущность NotificationSetting

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| dealership_id | bigint | Салон |
| channel_type | enum | Тип канала |
| is_enabled | boolean | Включён |
| notification_time | time | Время отправки |
| notification_day | int | День отправки (для weekly) |
| notification_offset | int | Смещение в минутах |
| recipient_roles | json | Роли получателей |

#### 2.13.3 Сущность TaskNotification (отслеживание отправленных уведомлений)

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| task_id | bigint | Ссылка на задачу |
| user_id | bigint | Получатель |
| notification_type | enum | upcoming_deadline, overdue, hour_overdue, unresponded_2h, unresponded_6h, unresponded_24h |
| sent_at | datetime | Время отправки |
| created_at | datetime | Время создания записи |

Используется для предотвращения повторной отправки уведомлений (дедупликация).

#### 2.13.4 Требования

| ID | Описание |
|----|----------|
| NOTIF-001 | Получение настроек уведомлений |
| NOTIF-002 | Обновление настроек канала |
| NOTIF-003 | Массовое обновление настроек |
| NOTIF-004 | Сброс к значениям по умолчанию |
| NOTIF-005 | Уникальность: (dealership_id, channel_type) |

---

### 2.14 Модуль настроек (Settings)

#### 2.14.1 Сущность Setting

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| dealership_id | bigint | Салон (null = глобально) |
| key | string | Ключ настройки |
| value | text | Значение |
| type | enum | string, integer, boolean, json, time |
| description | string | Описание |

#### 2.14.2 Ключи настроек

| Ключ | Тип | Описание |
|------|-----|----------|
| archive_completed_after_minutes | integer | Через сколько минут архивировать выполненные |
| archive_overdue_after_hours | integer | Через сколько часов архивировать просроченные |
| notification_deadline_minutes_before | integer | За сколько минут до дедлайна уведомлять |
| max_proof_files_per_response | integer | Макс. файлов на ответ (по умолчанию 5) |
| max_proof_file_size_mb | integer | Макс. размер файла в МБ (по умолчанию 200) |
| shift_default_duration_hours | integer | Длительность смены по умолчанию |

#### 2.14.3 Требования

| ID | Описание |
|----|----------|
| SET-001 | Получение всех настроек |
| SET-002 | Получение настройки по ключу |
| SET-003 | Обновление настройки |
| SET-004 | Группированные настройки: shift-config, notification-config, archive-config, task-config |
| SET-005 | Приоритет: сначала салон, затем глобальные |
| SET-006 | Приведение типов при чтении |

---

### 2.15 Модуль важных ссылок (ImportantLink)

#### 2.15.1 Сущность ImportantLink

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| title | string(255) | Название |
| url | string(500) | URL |
| description | text | Описание |
| dealership_id | bigint | Салон (null = глобально) |
| creator_id | bigint | Создатель |
| category | string | Категория |
| sort_order | int | Порядок сортировки |
| is_active | boolean | Активность |

#### 2.15.2 Требования

| ID | Описание |
|----|----------|
| LINK-001 | CRUD операции для ссылок |
| LINK-002 | Сортировка по sort_order |
| LINK-003 | Фильтрация по категории и активности |

---

### 2.16 Модуль аудита (AuditLog)

#### 2.16.1 Сущность AuditLog

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | Первичный ключ |
| table_name | string | Имя таблицы |
| record_id | bigint | ID записи |
| action | enum | created, updated, deleted |
| actor_id | bigint | Кто выполнил действие |
| dealership_id | bigint | Контекст салона |
| payload | json | Данные изменения (значения полей) |
| created_at | datetime | Время действия |

#### 2.16.2 Требования

| ID | Описание |
|----|----------|
| AUDIT-001 | Автоматическая запись изменений |
| AUDIT-002 | Получение логов с фильтрацией |
| AUDIT-003 | Получение списка акторов |
| AUDIT-004 | История конкретной записи (доступ: manager и owner) |
| AUDIT-005 | Полный список и акторы: только owner; история записи: manager и owner |

---

### 2.17 Модуль дашборда и отчётов

#### 2.17.1 Требования

| ID | Описание |
|----|----------|
| DASH-001 | Метрики и KPI на дашборде |
| DASH-002 | Список отчётов |
| DASH-003 | Детализация проблем по типу |
| DASH-004 | Агрегации по салонам |
| DASH-005 | Анализ трендов |

---

### 2.18 Модуль архива задач

#### 2.18.1 Причины архивации

| Причина | Описание |
|---------|----------|
| completed | Задача выполнена и заархивирована |
| expired | Задача просрочена и заархивирована после смены |
| manual | Ручная архивация |

#### 2.18.2 Требования

| ID | Описание |
|----|----------|
| ARCH-001 | Получение списка архивных задач |
| ARCH-002 | Экспорт архивных задач |
| ARCH-003 | Восстановление задачи из архива |
| ARCH-004 | Автоархивация выполненных (каждые 10 минут) |
| ARCH-005 | Автоархивация просроченных после смены (каждый час) |

---

## 3. Нефункциональные требования

### 3.1 Производительность

| ID | Требование |
|----|------------|
| PERF-001 | Время ответа API < 500ms для 95% запросов |
| PERF-002 | Eager loading для предотвращения N+1 запросов |
| PERF-003 | Индексы на часто используемых полях |
| PERF-004 | Пагинация для списковых эндпоинтов |

### 3.2 Безопасность

| ID | Требование |
|----|------------|
| SEC-001 | Аутентификация через Bearer tokens (Laravel Sanctum) |
| SEC-002 | Rate limiting на API endpoints |
| SEC-003 | Rate limiting на попытки входа |
| SEC-004 | Подписанные URL для приватных файлов |
| SEC-005 | Валидация содержимого файлов (magic bytes) |
| SEC-006 | CORS настройки |
| SEC-007 | SQL injection prevention (Eloquent ORM) |
| SEC-008 | Input validation через Form Requests |

### 3.3 Масштабируемость

| ID | Требование |
|----|------------|
| SCAL-001 | Очереди на Valkey для фоновых задач |
| SCAL-002 | Горизонтальное масштабирование воркеров |
| SCAL-003 | Stateless API (токены вместо сессий) |

### 3.4 Надёжность

| ID | Требование |
|----|------------|
| REL-001 | Мягкое удаление для сохранения истории |
| REL-002 | Транзакции для критических операций |
| REL-003 | Аудит-логи всех изменений |
| REL-004 | Валидация входных данных |

### 3.5 Тестирование

| ID | Требование |
|----|------------|
| TEST-001 | Минимум 50% покрытие тестами |
| TEST-002 | Unit тесты для сервисов |
| TEST-003 | Feature тесты для API endpoints |
| TEST-004 | Интеграционные тесты |

---

## 4. API спецификация

### 4.1 Базовый URL

```
/api/v1
```

### 4.2 Формат ответов

**Успешный ответ:**
```json
{
  "data": { ... },
  "meta": {
    "current_page": 1,
    "total": 100,
    "per_page": 15
  }
}
```

**Ошибка:**
```json
{
  "message": "Описание ошибки",
  "errors": {
    "field": ["Сообщение об ошибке"]
  }
}
```

### 4.3 Список endpoints

#### Аутентификация
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /session | Вход в систему |
| DELETE | /session | Выход из системы |
| GET | /session/current | Текущий пользователь |
| GET | /up | Health check |

#### Конфигурация загрузки файлов (публичный)
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /config/file-upload | Лимиты загрузки файлов |
| GET | /config/file-upload/{preset} | Лимиты для конкретного пресета |

#### Пользователи
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /users | Список пользователей |
| GET | /users/{id} | Детали пользователя |
| GET | /users/{id}/status | Онлайн-статус |
| POST | /users | Создание пользователя |
| PUT | /users/{id} | Обновление пользователя |
| DELETE | /users/{id} | Удаление пользователя |

#### Автосалоны
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /dealerships | Список салонов |
| GET | /dealerships/{id} | Детали салона |
| POST | /dealerships | Создание салона |
| PUT | /dealerships/{id} | Обновление салона |
| DELETE | /dealerships/{id} | Удаление салона |

#### Смены
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /shifts | Список смен |
| GET | /shifts/current | Текущая смена |
| GET | /shifts/my | Мои смены |
| GET | /shifts/my/current | Моя текущая смена |
| GET | /shifts/statistics | Статистика |
| GET | /shifts/{id} | Детали смены |
| POST | /shifts | Открытие смены |
| PUT | /shifts/{id} | Обновление смены |
| DELETE | /shifts/{id} | Удаление смены |
| GET | /shift-photos/{id}/{type} | Фото смены |

#### Задачи
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /tasks | Список задач |
| GET | /tasks/my-history | Моя история |
| GET | /tasks/{id} | Детали задачи |
| POST | /tasks | Создание задачи |
| PUT | /tasks/{id} | Обновление задачи |
| DELETE | /tasks/{id} | Удаление задачи |
| PATCH | /tasks/{id}/status | Обновление статуса/ответа |

#### Доказательства
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /task-proofs/{id} | Детали доказательства |
| DELETE | /task-proofs/{id} | Удаление доказательства |
| GET | /task-proofs/{id}/download | Скачивание |
| DELETE | /task-shared-proofs/{id} | Удаление общего доказательства |
| GET | /task-shared-proofs/{id}/download | Скачивание общего |

#### Верификация
| Метод | Путь | Описание |
|-------|------|----------|
| POST | /task-responses/{id}/approve | Подтверждение |
| POST | /task-responses/{id}/reject | Отклонение |
| POST | /tasks/{id}/reject-all-responses | Массовое отклонение |

#### Генераторы задач
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /task-generators | Список генераторов |
| GET | /task-generators/{id} | Детали генератора |
| GET | /task-generators/{id}/tasks | Созданные задачи |
| GET | /task-generators/{id}/stats | Статистика |
| POST | /task-generators | Создание |
| PUT | /task-generators/{id} | Обновление |
| DELETE | /task-generators/{id} | Удаление |
| POST | /task-generators/{id}/pause | Пауза |
| POST | /task-generators/{id}/resume | Возобновление |
| POST | /task-generators/pause-all | Пауза всех |
| POST | /task-generators/resume-all | Возобновление всех |

#### Архив
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /archived-tasks | Список архивных задач |
| GET | /archived-tasks/statistics | Статистика архивных задач |
| GET | /archived-tasks/export | Экспорт |
| POST | /archived-tasks/{id}/restore | Восстановление |

#### Важные ссылки
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /links | Список ссылок |
| GET | /links/{id} | Детали ссылки |
| POST | /links | Создание |
| PUT | /links/{id} | Обновление |
| DELETE | /links/{id} | Удаление |

#### Дашборд и отчёты
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /dashboard | Метрики |
| GET | /reports | Список отчётов |
| GET | /reports/issues/{type} | Детализация проблем |

#### Настройки
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /settings | Все настройки |
| GET | /settings/{key} | Настройка по ключу |
| GET | /settings/shift-config | Конфиг смен |
| GET | /settings/notification-config | Конфиг уведомлений |
| GET | /settings/archive-config | Конфиг архивации |
| GET | /settings/task-config | Конфиг задач |
| PUT | /settings/{key} | Обновление настройки (только owner) |
| POST | /settings/shift-config | Обновление конфига смен (только owner) |
| PUT | /settings/notification-config | Обновление конфига уведомлений (manager/owner) |
| PUT | /settings/archive-config | Обновление конфига архивации (manager/owner) |
| PUT | /settings/task-config | Обновление конфига задач (manager/owner) |

#### Настройки уведомлений
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /notification-settings | Список |
| PUT | /notification-settings/{channel} | Обновление канала |
| POST | /notification-settings/bulk | Массовое обновление |
| POST | /notification-settings/reset | Сброс к умолчаниям |

#### Календарь
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /calendar/{year} | Календарь на год (+ `uses_global` флаг) |
| GET | /calendar/{year}/holidays | Праздники (+ `uses_global` флаг) |
| GET | /calendar/check/{date} | Проверка даты |
| PUT | /calendar/{date} | Установка дня (автокопирование при первом изменении) |
| DELETE | /calendar/{date} | Удаление переопределения |
| POST | /calendar/bulk | Массовые операции (автокопирование при первом изменении) |
| DELETE | /calendar/{year}/reset | Сброс календаря автосалона к глобальному |

#### Аудит
| Метод | Путь | Описание |
|-------|------|----------|
| GET | /audit-logs | Логи (только owner) |
| GET | /audit-logs/actors | Список акторов (только owner) |
| GET | /audit-logs/{table}/{id} | История записи (manager/owner) |

---

## 5. Фоновые задачи

### 5.1 Jobs (асинхронные через Valkey)

| Job | Расписание | Описание |
|-----|------------|----------|
| ProcessTaskGeneratorsJob | каждые 5 минут | Генерация задач из шаблонов |
| StoreTaskProofsJob | по событию | Асинхронная загрузка файлов доказательств |
| StoreTaskSharedProofsJob | по событию | Асинхронная загрузка общих файлов группы |
| DeleteProofFileJob | по событию | Асинхронное удаление файлов из хранилища |

### 5.2 Commands (синхронные)

| Команда | Расписание | Описание |
|---------|------------|----------|
| tasks:archive-completed | каждые 10 минут | Архивация выполненных задач |
| tasks:archive-overdue-after-shift | каждый час | Архивация просроченных после смены |
| proofs:cleanup-temp | каждый час | Очистка временных файлов загрузки |

---

## 6. Структура хранения файлов

```
storage/
└── app/
    └── private/
        └── task_proofs/
            └── {dealership_id}/
                └── {task_id}/
                    └── {response_id}/
                        └── {filename}
```

---

## 7. Демо-данные

Система должна включать сидер для демонстрационных данных:

| Логин | Пароль | Роль |
|-------|--------|------|
| admin | password | owner |
| manager1 | password | manager |
| emp1_1 | password | employee |

---

## 8. Требования к развёртыванию

### 8.1 Docker

- Все сервисы запускаются через podman compose
- Команды выполняются через `podman compose exec api`

### 8.2 Инициализация

```bash
podman compose up -d --build
podman compose exec api composer install
podman compose exec api php artisan migrate --force
podman compose exec api php artisan db:seed-demo
podman compose exec api php artisan storage:link
```

### 8.3 Порты

- Backend API: 8007
- Frontend: 8099

---

## 9. Глоссарий

| Термин | Определение |
|--------|-------------|
| Автосалон (Dealership) | Организация-клиент системы |
| Задача (Task) | Единица работы, назначаемая сотрудникам |
| Генератор задач (TaskGenerator) | Шаблон для автоматического создания повторяющихся задач |
| Смена (Shift) | Рабочий период сотрудника |
| Доказательство (Proof) | Файл, подтверждающий выполнение задачи |
| Верификация | Процесс проверки доказательств менеджером |
| Архивация | Перемещение завершённых/просроченных задач в архив |

---

## 10. История изменений документа

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | — | Первоначальная версия ТЗ |
| 1.1 | 27.01.2026 | Актуализация: добавлено поле timezone в AutoDealership; уточнены ограничения файлов по категориям (5/50/100 МБ); расширен список форматов (DOC, DOCX, XLS, XLSX, CSV, ODT, TXT, JSON, TAR, 7Z, WebM, AVI); добавлены Jobs (StoreTaskProofsJob, StoreTaskSharedProofsJob, DeleteProofFileJob); добавлена команда proofs:cleanup-temp; удалён несуществующий ProcessRecurringTasksJob |
| 1.2 | 27.01.2026 | Модуль календаря: новая логика раздельного хранения (глобальный ИЛИ собственный, без смешивания); автокопирование глобальных записей при первом изменении автосалона; флаг `uses_global` в ответах API; новый endpoint `DELETE /calendar/{year}/reset` для сброса к глобальному; требования CAL-007–CAL-010 |
| 1.3 | 28.01.2026 | Актуализация по коду: исправлена сущность AuditLog (поля `actor_id`, `payload` вместо `user_id`, `old_values`/`new_values`; убраны `ip_address`/`user_agent`); добавлено поле `last_failed_login_at` в User; добавлена сущность TaskGeneratorAssignment (назначения генераторов); добавлена сущность TaskNotification (дедупликация уведомлений); уточнены права доступа: настройки notification/archive/task-config доступны manager+owner, аудит-лог истории записи доступен manager+owner; добавлены endpoints: `/config/file-upload`, `/archived-tasks/statistics`; уточнены права в матрице доступа и API endpoints |

---

*Документ подготовлен на основе анализа реализованной системы TaskMate Server.*
